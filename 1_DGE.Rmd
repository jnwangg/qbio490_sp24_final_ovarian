---
title: "QBIO 490: Final Project"
subtitle: "Differential Expression Analysis of Ovarian Carcinoma"
author: "Daven Pan, Aman Sharma, Joseph Kim, and Justin Wang"
output:
  pdf_document:
    highlight: arrow
---

# Configuration and Packages
```{r}
# Working directory; modify this path as needed.
knitr::opts_knit$set(root.dir = normalizePath("/analysis_data/"))
```

```{r, message = FALSE}
if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")

if (!require("TCGAbiolinks", quietly = TRUE))
BiocManager::install("TCGAbiolinks")

if (!require("ggplot2", quietly = TRUE))
install.packages("ggplot2")

if (!require("Seurat", quietly = TRUE))
install.packages("Seurat")

if (!require("dplyr", quietly = TRUE))
install.packages("dplyr")

library(BiocManager)
library(TCGAbiolinks)
library(ggplot2)
library(consensusOV)
library(dplyr)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(biomaRt)
library(matrixStats)
library(NMF)
library(RcppML)
library(clusterProfiler)
```

# Data Download

```{r}
# Download clinical data.
clin_query <- GDCquery(project = "TCGA-OV",
  data.category = "Clinical",
  data.type = "Clinical Supplement",
  data.format = 'BCR Biotab')

# GDCdownload(clin_query, directory = "/analysis_data/Ovarian_GDCdata")

clinical.BCRtab.all <- GDCprepare(clin_query, directory = "/analysis_data/Ovarian_GDCdata/")
```

```{r, message = FALSE}
# Download RNA expression data.
rna_query <- GDCquery(project ="TCGA-OV",
  data.category = "Transcriptome Profiling",
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts")

# GDCdownload(rna_query, directory = "/analysis_data/Ovarian_GDCdata/")

rna_se <- GDCprepare(rna_query, directory = "/analysis_data/Ovarian_GDCdata/")
```

```{r}
# Disinstantiate query objects.
remove(clin_query, rna_query)
```

# Data Cleaning and Preparation
```{r, message = FALSE}
################################################################################
# Create clinical dataframe.
rna_clinical <- as.data.frame(rna_se@colData)

# Remove "nested lists":
rna_clinical <- subset(rna_clinical, select = -c(treatments, primary_site, disease_type))

################################################################################
# Create gene dataframe.
rna_genes <- as.data.frame(rna_se@rowRanges@elementMetadata)

# Remove version numbers from ENSEMBL IDs.
rna_genes$gene_id <- gsub("\\.\\d+$", "", rna_genes$gene_id)

# Update rownames to reflect gene IDs.
rownames(rna_genes) <- rna_genes$gene_id

################################################################################
# Create counts dataframe.
rna_counts <- as.data.frame(rna_se@assays@data$unstranded)

# Update row and column names to reflect ENSEMBL IDs and patient barcodes.
rownames(rna_counts) <- rownames(rna_genes)
colnames(rna_counts) <- rownames(rna_clinical)

# Filter genes detected in fewer than ten patients.
rna_counts <- rna_counts[rowSums(rna_counts > 0) >= 20, ]
rna_genes <- rna_genes[rownames(rna_genes) %in% rownames(rna_counts), ]

# Convert ENSEMBL IDs to Entrez IDs.
entrez <- select(org.Hs.eg.db, keys = rownames(rna_counts), columns = "ENTREZID", keytype = "ENSEMBL")

# Filter NA conversions and de-duplicate genes.
entrez <- entrez[which(is.na(entrez$ENTREZID) == FALSE), ]
entrez <- entrez[which(duplicated(entrez$ENTREZID) == FALSE), ]

# Subset counts to include only converted genes.
rna_counts <- subset(rna_counts, rownames(rna_counts) %in% entrez$ENSEMBL)
rna_genes <- subset(rna_genes, rna_genes$gene_id %in% entrez$ENSEMBL)

# Update rownames in counts and gene dataframes.
rownames(rna_counts) <- entrez$ENTREZID[match(rownames(rna_counts), entrez$ENSEMBL)]
rownames(rna_genes) <- entrez$ENTREZID[match(rownames(rna_genes), entrez$ENSEMBL)]

# Filter Entrez IDs to match rows in counts.
entrez <- subset(entrez, entrez$ENTREZID %in% rownames(rna_counts))
```

# Preprocessing and Clustering
```{r, warning = FALSE, message = FALSE}
# Select genes with the highest variability across patients by median absolute deviation.
mads <- rowMads(as.matrix(rna_counts))
mads <- head(names(mads[order(-mads)]), n = 2000)
rna_counts <- rna_counts[rownames(rna_counts) %in% mads, ]

# Run non-negative matrix factorization clustering for 100 iterations.
nmf_model <- nmf(rna_counts, rank = 4, nrun = 100, .opt='vP')
consensusmap(nmf_model, tracks = c("basis:", "consensus:"))

# Filter patients based on silhouette width.
sil <- as.data.frame(silhouette(nmf_model))
ggplot(data = sil, aes(x = sil$sil_width)) +
  geom_histogram(fill="#69b3a2", color = "#ffffff", alpha=0.6, bins = 10) +
  labs(x = "Silhoutte Width", y = "Count", title = "NMF Silhouette Widths") +
  theme_minimal()
sil <- sil[sil$sil_width >= 0.25, ]

# Extract basis and mixture coefficient matrices.
nmf_w <- basis(nmf_model)
nmf_h <- t(coef(nmf_model))
colnames(nmf_h) <- paste0("NMF_", paste0("",1:4))

# Subset counts and mixture coefficient matrices from silhouette width.
nmf_h <- nmf_h[rownames(nmf_h) %in% rownames(sil), ]
rna_counts <- rna_counts[, colnames(rna_counts) %in% rownames(sil)]

# Initialize Seurat object.
ovarian <- CreateSeuratObject(rna_counts, project = "TCGA_Ovarian")

# Add NMF matrices as a reduction.
ovarian@reductions$nmf <- CreateDimReducObject(
  embeddings = nmf_h,
  loadings = nmf_w,
  key = "NMF_",
  assay = "RNA"
)

# Find neighbors and run UMAP on the NMF reduction.
ovarian <- FindNeighbors(ovarian, reduction = "nmf", dims = 1:4, k.param = 4)
ovarian <- RunUMAP(ovarian, reduction = "nmf", dims = 1:4)

# Set active idents to NMF-assigned clusters and visualize.
ovarian <- SetIdent(ovarian, cells = rownames(nmf_h), value = paste0("NMF_", apply(nmf_h, 1, which.max)))
DimPlot(ovarian, reduction = "umap")
```

# Differential Expression Analysis
```{r}
# Find differentially expressed genes by cluster.
markers <- FindAllMarkers(ovarian, slot = "counts")
markers$gene_names <- mapIds(org.Hs.eg.db, keys = markers$gene, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")

# Extract top 10 DEGs and group by cluster.
markers %>% group_by(cluster) %>% top_n(n = 30, wt = avg_log2FC) -> markers_t30

# Compare subtypes with consensus classifier (Chen et al.).
test <- get.consensus.subtypes(rna_counts, entrez$ENTREZID[entrez$ENTREZID %in% mads])
```

# Gene Ontology Analysis
```{r}
# Split markers by cluster and convert ENSEMBL IDs to Entrez IDs.
cluster.markers <- split(markers_t30$gene, f = markers_t30$cluster)

# Perform gene ontology analysis by cluster.
compGO <- compareCluster(geneClusters = cluster.markers,
                         fun = "enrichGO",
                         OrgDb = "org.Hs.eg.db")

# Visualize GO terms.
dotplot(compGO)
```
